name: Publish to Open VSX (personal via CI patch)

on:
  push:
    tags: [ "v*.*.*" ]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      MY_OVSX_PUBLISHER: jonathanwpedersen   # <-- your Open VSX namespace (lowercase)

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-node@v4
        with: { node-version: "20" }

      - name: Install deps
        run: npm ci || npm install

      - name: Patch package.json publisher (CI-only)
        run: |
          node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('package.json','utf8'));p.publisher=process.env.MY_OVSX_PUBLISHER;p.displayName=(p.displayName||p.name)+' (Unofficial)';fs.writeFileSync('package.json',JSON.stringify(p,null,2));"

      - name: Ensure Open VSX namespace exists
        run: npx --yes ovsx create-namespace "$MY_OVSX_PUBLISHER" --pat "${{ secrets.OPEN_VSX_TOKEN_PERSONAL }}" || echo "Namespace already exists"

      - name: Build (if needed)
        run: npm run build --if-present

      - name: Publish to Open VSX
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN_PERSONAL }}
          packagePath: ./
