name: Publish to Open VSX (personal via CI patch)

on:
  push:
    tags: [ "v*.*.*" ]   # e.g. v0.6.0, v0.6.1
  workflow_dispatch:      # manual run from Actions tab

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      MY_OVSX_PUBLISHER: JonathanWPedersen   # <-- your Open VSX namespace

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-node@v4
        with: { node-version: "20" }

      - name: Show files (debug)
        run: ls -la

      - name: Install deps
        run: npm ci || npm install

      # CI-only: swap publisher/displayName â€” doesn't modify git
      - name: Patch package.json publisher (CI-only)
        run: |
          node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('package.json','utf8'));p.publisher=process.env.MY_OVSX_PUBLISHER;p.displayName=(p.displayName||p.name)+' (Unofficial)';fs.writeFileSync('package.json',JSON.stringify(p,null,2));"

      - name: Build (if needed)
        run: npm run build --if-present

      # Let the action PACKAGE + PUBLISH from the repo root
      - name: Publish to Open VSX
        id: openvsx
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN_PERSONAL }}
          packagePath: ./   # change only if the extension is in a subfolder

      - name: Echo VSIX path (debug)
        run: echo "VSIX = ${{ steps.openvsx.outputs.vsixPath }}"
